# EU Vote mechanism
add_namespace = EUvote
add_namespace = EUvote_news

country_event = {
	id = EUvote.1
	title = EUvote.1.t
	desc = EUvote.1.d
	
	is_triggered_only = yes

	immediate = { }
	
	option = {
		name = EUvote.1.a # yes
		ai_chance = { 
			factor = 50 # base voting factor 50:50
				modifier = {
					add = -25
					has_country_flag = gov_strong_resist
				}
				modifier = {
					add = -10
					has_country_flag = gov_resist
				}
				modifier = {
					add = 10
					has_country_flag = gov_support
				}
				modifier = {
					add = 25
					has_country_flag = gov_strong_support
				}				
				modifier = {
					add = 5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.05 }
						}
				}
				modifier = {
					add = 5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.1 }
						}
				}
				modifier = {
					add = 10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.25 }
						}
				}
				modifier = {
					add = 10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.5 }
						}
				}
				modifier = {
					add = 15
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.7 }
						}
				}	
				modifier = {
					add = -5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.1
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.2
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.3
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -10
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.5
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -20
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.7
								compare = greater_than_or_equals
							}
						}
				}
		}
			add_to_variable = {
				var = global.var_EUvoteYes
				value = 1
				}
			add_to_variable = {
				var = global.var_EUpopYes
				value = THIS.var_EUpopRatio
				}
			add_to_variable = {
				var = global.var_EUvoteTotal
				value = 1
				}				
			set_country_flag = EU_voted
			set_country_flag = EU_voted_yes
	}
	option = {
		name = EUvote.1.b # no
		ai_chance = {
			factor = 50 # base voting factor 50:50
				modifier = {
					add = 25
					has_country_flag = gov_strong_resist
				}
				modifier = {
					add = 10
					has_country_flag = gov_resist
				}
				modifier = {
					add = -10
					has_country_flag = gov_support
				}
				modifier = {
					add = -25
					has_country_flag = gov_strong_support
				}
				modifier = {
					add = -5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.05 }
						}
				}
				modifier = {
					add = -5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.1 }
						}
				}
				modifier = {
					add = -10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.25 }
						}
				}
				modifier = {
					add = -10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.5 }
						}
				}
				modifier = {
					add = -15
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.7 }
						}
				}
				modifier = {
					add = 5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.1
								compare = greater_than_or_equals
							}
						}
				}				
				modifier = {
					add = 5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.2
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = 5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.3
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = 10
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.5
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = 20
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.7
								compare = greater_than_or_equals
							}
						}
				}
			}
			add_to_variable = {
				var = global.var_EUvoteNo
				value = 1
				}
			add_to_variable = {
				var = global.var_EUpopNo
				value = THIS.var_EUpopRatio
				}
			add_to_variable = {
				var = global.var_EUvoteTotal
				value = 1
				}				
			set_country_flag = EU_voted
			set_country_flag = EU_voted_no
	}
}

country_event = {
	id = EUvote.2 ### counting voting result focus_EU001
	title = EUvote.2.t
	desc = EUvote.2.d
	
#	trigger = {
#		has_country_flag = focus_EU001
#		has_global_flag = focus_EU001_voted
#		check_variable = {
#			var = global.var_EUvoteTotal
#			value = global.var_EUmemberstatesTotal
#			compare = equals
#		}
#	}
	
#	mean_time_to_happen = { days = 1 }

	is_triggered_only = yes

	fire_only_once = yes
	
	#immediate = { }
	
	
	option = {
		if = { # Unanimity - yes 
			limit = {
				has_global_flag = EU_unanimity_voting
				check_variable = {
					var = global.var_EUvoteYes
					value = global.var_EUvoteTotal
					compare = equals
				}			
			}
			set_country_flag = focus_EU001_yes
			set_global_flag = EU_unanimity_voting_YES
			every_country = {
				limit = { has_country_flag = EU_voted }
				news_event = {
					id = EUvote_news.2
				}
			}
		}
		else_if = { # QMV - yes 
			limit = {
				AND = {
					has_global_flag = EU_qualified_majority_voting
					check_variable = {
						var = global.var_EUvoteYes
						value = 0.55
						compare = greater_than_or_equals
					}
					check_variable = {
						var = global.var_EUpopYes
						value = 0.65
						compare = greater_than_or_equals
					}
				}			
			}
			set_country_flag = focus_EU001_QMV_yes
			set_global_flag = EU_qualified_majority_voting_YES
			every_country = {
				limit = { has_country_flag = EU_voted }
				news_event = {
					id = EUvote_news.2
				}
			}
		}		
		else_if = { # majority - yes 
			limit = {
				has_global_flag = EU_majority_voting
				set_temp_variable = { 
					temp1 = global.var_EUvoteTotal 
				}
				divide_temp_variable = { 
					temp1 = 2 
				}
				check_variable = {
					var = global.var_EUvoteYes
					value = temp1
					compare = greater_than
				}			
			}
			set_country_flag = focus_EU001_maj_yes
			set_global_flag = EU_majority_voting_YES
			every_country = {
				limit = { has_country_flag = EU_voted }
				news_event = {
					id = EUvote_news.2
				}
			}
		}		
		else_if = { # Unanimity - no
			limit = {
				has_global_flag = EU_unanimity_voting
				check_variable = {
					var = global.var_EUvoteYes
					value = global.var_EUvoteTotal
					compare = not_equals
				}
			}
			set_country_flag = focus_EU001_no
			set_global_flag = EU_unanimity_voting_NO
			every_country = {
				limit = { has_country_flag = EU_voted }
				news_event = {
					id = EUvote_news.2
				}
			}
		}		
		else_if = { # QMV - no
			limit = {
				has_global_flag = EU_qualified_majority_voting
				OR = {
					check_variable = {
						var = global.var_EUvoteYes
						value = 0.55
						compare = less_than
					}
					check_variable = {
						var = global.var_EUpopYes
						value = 0.65
						compare = less_than
					}
				}
			}
			set_country_flag = focus_EU001_QMV_no
			set_global_flag = EU_unanimity_voting_NO
			every_country = {
				limit = { has_country_flag = EU_voted }
				news_event = {
					id = EUvote_news.2
				}
			}
		}		
		else = {
			set_country_flag = focus_EU001_maj_no
			set_global_flag = EU_unanimity_voting_NO
			every_country = {
				limit = { has_country_flag = EU_voted }
				news_event = {
					id = EUvote_news.2
				}
			}
		}
	}
	
}

news_event = { 
	id = EUvote_news.2
	title = EU_news.2.t
	desc = EU_news.2.d
	picture = GFX_eu
	
	major = no
	is_triggered_only = yes
	
	option = {
		name = EU_news.2.a
	}
}


############################ id's have to be updated

country_event = {
	id = EUvote.12
	title = EUvote.12.t
	desc = EUvote.12.d
	
	is_triggered_only = yes

	immediate = { }
	
	
	option = {
		name = EUvote.12.a # yes
			clear_variable = global.var_EUvoteYes
			clear_variable = global.var_EUvoteNo
			clear_variable = global.var_EUvoteTotal
			clear_variable = global.var_EUpopYes
			clear_variable = global.var_EUpopNo
			clear_variable = global.var_EUpopTotal
			clear_variable = global.var_EUvoteNoQuote
			clear_variable = global.var_EUpopNoQuote			
			clr_country_flag = EU_voted
			clr_country_flag = gov_strong_resist
			clr_country_flag = gov_resist
			clr_country_flag = gov_support
			clr_country_flag = gov_strong_support
			clr_country_flag = EU_voted_yes
			clr_country_flag = EU_voted_no			
			if = {
				limit = {
					AND = {
						has_country_flag = focus01
						has_global_flag = focus01voted
					}
				}
				set_country_flag = focus01yes
			}
	}
}

country_event = {
	id = EUvote.13
	title = EUvote.13.t
	desc = EUvote.13.d
	
	is_triggered_only = yes

	immediate = { }
	
	
	option = {
		name = EUvote.13.a # no
			clear_variable = global.var_EUvoteYes
			clear_variable = global.var_EUvoteNo
			clear_variable = global.var_EUvoteTotal
			clear_variable = global.var_EUpopYes
			clear_variable = global.var_EUpopNo
			clear_variable = global.var_EUpopTotal
			clear_variable = global.var_EUvoteNoQuote
			clear_variable = global.var_EUpopNoQuote
			clr_country_flag = EU_voted
			clr_country_flag = gov_strong_resist
			clr_country_flag = gov_resist
			clr_country_flag = gov_support
			clr_country_flag = gov_strong_support			
			if = {
				limit = {
					AND = {
						has_country_flag = focus01
						has_global_flag = focus01voted
					}
				}
				FROM = { set_country_flag = focus01no }
				clr_global_flag = focus01again
			}			
	}
}
country_event = {
	id = EUvote.14
	title = EUvote.14.t
	desc = EUvote.14.d
	
	is_triggered_only = yes

	immediate = { }
	
	
	option = {
		name = EUvote.14.a # No vote quote QMV
			set_variable = { 
				var = global.var_EUvoteNoQuote
				value = global.var_EUvoteNo
			
			}
			set_variable = { 
				var = global.var_EUpopNoQuote
				value = global.var_EUpopNo
			
			}			
			divide_variable = { 
				var = global.var_EUvoteNoQuote
				value = global.var_EUvoteTotal
			
			}
			divide_variable = { 
				var = global.var_EUpopNoQuote
				value = global.var_EUpopTotal
			
			}
	}
}
country_event = {
	id = EUvote.15 ### new try for all member states
	title = EUvote.15.t
	desc = EUvote.15.d
	
	trigger = {
		has_country_flag = focus01no
		NOT = { has_global_flag = focus01again }
	}
	mean_time_to_happen = {
		days = 10 ### 180 days
	}

#	immediate = { }
	
	
	option = {
		name = EUvote.15.a # 
			clr_country_flag = focus01no
			clr_global_flag = focus01voted
			set_global_flag = focus01again
			every_country = {
				limit = { has_idea = EU_member }
					set_country_flag = focus01
					if = {
						limit = { has_country_flag = focus01_maj }
						set_country_flag = focus01_maj	
					}
					if = {
						limit { has_country_flag = focus01_QMV }
						set_country_flag = focus01_QMV
					}
				
			}
	}
}
