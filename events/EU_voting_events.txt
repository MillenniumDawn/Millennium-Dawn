# EU Vote mechanism
add_namespace = EUvote
add_namespace = EUvote_news

country_event = {
	id = EUvote.1
	title = EUvote.1.t
	desc = EUvote.1.d
	
	is_triggered_only = yes

	immediate = { }
	
	option = {
		name = EUvote.1.a # yes
		ai_chance = { 
			factor = 50 # base voting factor 50:50
				modifier = { ### EU Voting Cheat yes
					add = 1000
					has_global_flag = EU_voting_cheat_yes
				}
				modifier = { ### EU Voting Cheat no
					add = -1000
					has_global_flag = EU_voting_cheat_no
				}				
				modifier = {
					add = -25
					has_country_flag = gov_strong_resist
				}
				modifier = {
					add = -10
					has_country_flag = gov_resist
				}
				modifier = {
					add = 10
					has_country_flag = gov_support
				}
				modifier = {
					add = 25
					has_country_flag = gov_strong_support
				}				
				modifier = {
					add = 5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.05 }
						}
				}
				modifier = {
					add = 5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.1 }
						}
				}
				modifier = {
					add = 10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.25 }
						}
				}
				modifier = {
					add = 10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.5 }
						}
				}
				modifier = {
					add = 15
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.7 }
						}
				}	
				modifier = {
					add = -5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.1
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.2
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.3
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -10
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.5
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = -20
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.7
								compare = greater_than_or_equals
							}
						}
				}
		}
			add_to_variable = {
				var = global.var_EUvoteYes
				value = 1
				}
			add_to_variable = {
				var = global.var_EUpopYes
				value = THIS.var_EUpopRatio
				}
			add_to_variable = {
				var = global.var_EUvoteTotal
				value = 1
				}				
			set_country_flag = EU_voted
			set_country_flag = EU_voted_yes
	}
	option = {
		name = EUvote.1.b # no
		ai_chance = {
			factor = 50 # base voting factor 50:50
				modifier = { ### EU Voting Cheat yes
					add = -1000
					has_global_flag = EU_voting_cheat_yes
				}
				modifier = { ### EU Voting Cheat no
					add = 1000
					has_global_flag = EU_voting_cheat_no
				}			
				modifier = {
					add = 25
					has_country_flag = gov_strong_resist
				}
				modifier = {
					add = 10
					has_country_flag = gov_resist
				}
				modifier = {
					add = -10
					has_country_flag = gov_support
				}
				modifier = {
					add = -25
					has_country_flag = gov_strong_support
				}
				modifier = {
					add = -5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.05 }
						}
				}
				modifier = {
					add = -5
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.1 }
						}
				}
				modifier = {
					add = -10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.25 }
						}
				}
				modifier = {
					add = -10
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.5 }
						}
				}
				modifier = {
					add = -15
						THIS = {
							set_temp_variable = { temp_idx = -1 }
								any_of = {
									array = influence_array
									value = v
									index = i
									if = {
										limit = {
											var:v = { tag = FROM } 
										}
										set_temp_variable = { temp_idx = i }
										always = yes
									}
									else = { always = no }
								}
								check_variable = { temp_idx > -1 }
								check_variable = { influence_array_calc^temp_idx > 0.7 }
						}
				}
				modifier = {
					add = 5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.1
								compare = greater_than_or_equals
							}
						}
				}				
				modifier = {
					add = 5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.2
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = 5
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.3
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = 10
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.5
								compare = greater_than_or_equals
							}
						}
				}
				modifier = {
					add = 20
						ROOT = {	
							check_variable = {
								var = eurosceptic
								value = 0.7
								compare = greater_than_or_equals
							}
						}
				}
			}
			add_to_variable = {
				var = global.var_EUvoteNo
				value = 1
				}
			add_to_variable = {
				var = global.var_EUpopNo
				value = THIS.var_EUpopRatio
				}
			add_to_variable = {
				var = global.var_EUvoteTotal
				value = 1
				}				
			set_country_flag = EU_voted
			set_country_flag = EU_voted_no
	}
}

country_event = {
	id = EUvote.2 ### counting voting result focus_EU001
	title = EUvote.2.t
	desc = EUvote.2.d

	is_triggered_only = yes

#	fire_only_once = yes
	
	option = {
		name = EUvote.2.a #Show the result of the voting
		if = { # Unanimity - yes 
			limit = {
				has_global_flag = EU_unanimity_voting
				check_variable = {
					var = global.var_EUvoteYes
					value = global.var_EUvoteTotal
					compare = equals
				}			
			}
			set_country_flag = focus_EU001_yes
			set_global_flag = EU_unanimity_voting_YES
			every_country = {
				limit = { 
					has_country_flag = EU_voted
					NOT = { has_country_flag = focus_EU001 }
				}
				news_event = {
					id = EUvote_news.2
				}
			}
			every_country = {
				limit = { has_country_flag = focus_EU001 }
				news_event = {
					id = EUvote.3
				}
			}			
		}
		else_if = { # QMV - yes 
			limit = {
				AND = {
					has_global_flag = EU_qualified_majority_voting
					check_variable = {
						var = global.var_EUvoteYes
						value = 0.55
						compare = greater_than_or_equals
					}
					check_variable = {
						var = global.var_EUpopYes
						value = 0.65
						compare = greater_than_or_equals
					}
				}			
			}
			set_country_flag = focus_EU001_QMV_yes
			set_global_flag = EU_qualified_majority_voting_YES
			every_country = {
				limit = { 
					has_country_flag = EU_voted
					NOT = { has_country_flag = focus_EU001 }
				}
				news_event = {
					id = EUvote_news.2
				}
			}
			every_country = {
				limit = { has_country_flag = focus_EU001_QMV }
				news_event = {
					id = EUvote.3
				}
			}			
		}		
		else_if = { # majority - yes 
			limit = {
				has_global_flag = EU_majority_voting
				set_temp_variable = { 
					temp1 = global.var_EUvoteTotal 
				}
				divide_temp_variable = { 
					temp1 = 2 
				}
				check_variable = {
					var = global.var_EUvoteYes
					value = temp1
					compare = greater_than
				}			
			}
			set_country_flag = focus_EU001_maj_yes
			set_global_flag = EU_majority_voting_YES
			every_country = {
				limit = { 
					has_country_flag = EU_voted
					NOT = { has_country_flag = focus_EU001 }
				}
				news_event = {
					id = EUvote_news.2
				}
			}
			every_country = {
				limit = { has_country_flag = focus_EU001_maj }
				news_event = {
					id = EUvote.3
				}
			}			
		}		
		else_if = { # Unanimity - no
			limit = {
				has_global_flag = EU_unanimity_voting
				check_variable = {
					var = global.var_EUvoteYes
					value = global.var_EUvoteTotal
					compare = not_equals
				}
			}
			set_country_flag = focus_EU001_no
			set_global_flag = EU_unanimity_voting_NO
			every_country = {
				limit = { 
					has_country_flag = EU_voted
					NOT = { has_country_flag = focus_EU001 }
				}
				news_event = {
					id = EUvote_news.2
				}
			}
			every_country = {
				limit = { has_country_flag = focus_EU001 }
				news_event = {
					id = EUvote.4
				}
			}			
		}		
		else_if = { # QMV - no
			limit = {
				has_global_flag = EU_qualified_majority_voting
				OR = {
					check_variable = {
						var = global.var_EUvoteYes
						value = 0.55
						compare = less_than
					}
					check_variable = {
						var = global.var_EUpopYes
						value = 0.65
						compare = less_than
					}
				}
			}
			set_country_flag = focus_EU001_QMV_no
			set_global_flag = EU_qualified_majority_voting_NO
			every_country = {
				limit = { 
					has_country_flag = EU_voted
					NOT = { has_country_flag = focus_EU001 }
				}
				news_event = {
					id = EUvote_news.2
				}
			}
			every_country = {
				limit = { has_country_flag = focus_EU001_QMV }
				news_event = {
					id = EUvote.4
				}
			}			
		}		
		else = {
			set_country_flag = focus_EU001_maj_no
			set_global_flag = EU_majority_voting_NO
			every_country = {
				limit = { 
					has_country_flag = EU_voted
					NOT = { has_country_flag = focus_EU001 }
				}
				news_event = {
					id = EUvote_news.2
				}
			}
			every_country = {
				limit = { has_country_flag = focus_EU001_maj }
				news_event = {
					id = EUvote.4
				}
			}
		}
	}
	
}

news_event = { 
	id = EUvote_news.2
	title = EU_news.2.t
	desc = EU_news.2.d
	picture = GFX_eu
	
	major = no
	is_triggered_only = yes
	
	option = {
		name = EU_news.2.a
	}
}


### changed EUvote.3 and EUvote.4 fired from EUvote.2 to news event instead of country event

news_event = {
	id = EUvote.3 ### voting result focus_EU001 yes and focus_EU001 effect
	title = EUvote.3.t
	desc = EUvote.3.d
	picture = GFX_eu
	
	is_triggered_only = yes

	immediate = { }
	
	
	option = {
		name = EUvote.3.a # yes
			clear_variable = global.var_EUvoteYes
			clear_variable = global.var_EUvoteNo
			clear_variable = global.var_EUvoteTotal
			clear_variable = global.var_EUpopYes
			clear_variable = global.var_EUpopNo
			every_country = {
				limit = {
					has_idea = EU_member
				}	
				clr_country_flag = EU_voted
				clr_country_flag = gov_strong_resist
				clr_country_flag = gov_resist
				clr_country_flag = gov_support
				clr_country_flag = gov_strong_support
				clr_country_flag = EU_voted_yes
				clr_country_flag = EU_voted_no
			}
			clr_global_flag = EU_unanimity_voting
			clr_global_flag = EU_qualified_majority_voting
			clr_global_flag = EU_majority_voting
			clr_global_flag = focus_EU001_result
			clr_global_flag = focus_EU001_QMV_result
			clr_global_flag = focus_EU001_maj_result

			clr_global_flag = EU_unanimity_voting_YES
			clr_global_flag = EU_qualified_majority_voting_YES
			clr_global_flag = EU_majority_voting_YES
			clr_global_flag = EU_unanimity_voting_NO
			clr_global_flag = EU_qualified_majority_voting_NO
			clr_global_flag = EU_majority_voting_NO			
			if = {
				limit = {
					OR = {
						has_country_flag = focus_EU001_yes
						has_country_flag = focus_EU001_QMV_yes
						has_country_flag = focus_EU001_maj_yes
					}
				}
				every_country = {
					limit = {
						has_country_flag = focus_EU001
					}
					### focus01 effect
				}
			}
	}
}

news_event = {
	id = EUvote.4 ### voting result focus_EU001 yes and focus_EU001 effect
	title = EUvote.4.t
	desc = EUvote.4.d
	picture = GFX_eu
	
	is_triggered_only = yes

	immediate = { }
	
	
	option = {
		name = EUvote.4.a # no
			clear_variable = global.var_EUvoteYes
			clear_variable = global.var_EUvoteNo
			clear_variable = global.var_EUvoteTotal
			clear_variable = global.var_EUpopYes
			clear_variable = global.var_EUpopNo
			every_country = {
				limit = {
					has_idea = EU_member
				}	
				clr_country_flag = EU_voted
				clr_country_flag = gov_strong_resist
				clr_country_flag = gov_resist
				clr_country_flag = gov_support
				clr_country_flag = gov_strong_support
				clr_country_flag = EU_voted_yes
				clr_country_flag = EU_voted_no
			}
			clr_global_flag = EU_unanimity_voting
			clr_global_flag = EU_qualified_majority_voting
			clr_global_flag = EU_majority_voting
			clr_global_flag = focus_EU001_result
			clr_global_flag = focus_EU001_QMV_result
			clr_global_flag = focus_EU001_maj_result

			clr_global_flag = EU_unanimity_voting_YES
			clr_global_flag = EU_qualified_majority_voting_YES
			clr_global_flag = EU_majority_voting_YES
			clr_global_flag = EU_unanimity_voting_NO
			clr_global_flag = EU_qualified_majority_voting_NO
			clr_global_flag = EU_majority_voting_NO			
	}
}



