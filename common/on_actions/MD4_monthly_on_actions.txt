# monthly on_action by Yard1

on_actions = {
	on_startup = { # on_daily is executed before on_startup
		effect = {
			add_to_variable = { global.next_month = 1 }
		}
	}

	# this is executed on the 1st of every month FOR ONE RANDOM COUNTRY - use every_country inside
	on_daily = {
		effect = {
			if = {
				# don't touch!
				limit = {
					NOT = { 
						has_global_flag = on_monthly_done
					}
					meta_trigger = {
						text = {
							date > [YEAR].[MONTH].1
						}
						YEAR = "[?global.year]"
						MONTH = "[?global.next_month]"
					}
				}
				add_to_variable = { global.month = 1 }
				add_to_variable = { global.next_month = 1 }
				set_global_flag = { flag = on_monthly_done value = 1 days = 27 }
				if = {
					limit = { check_variable = { global.month > 12 } }
					set_variable = { global.month = 1 }
				}
				if = {
					limit = { check_variable = { global.next_month > 12 } }
					set_variable = { global.next_month = 1 }
					set_global_flag = { flag = on_monthly_done value = 1 days = 31 }
				}
				# this is done only ONCE per month, even though on_daily fires for every country
				# will also be done on startup

				# your code here
				set_power_ranking_ideas_for_every_country = yes
				country_event = { id = low_stability.1 }
				
				#killrabbit stuff
				every_country = {
					ingame_calculate_size_modifier = yes #updates economics if new factories has been added
					recalculate_party = yes
					
					#player only updates
					if = { limit = { is_ai = no }
					
						update_military_rate = yes
						2017_state_init_setup = yes		#updates all player states if population has grown enough
						
						if = { limit = { can_upgrade_gdp = yes NOT = { has_country_flag = Max_GDPC } has_global_flag = do_not_do_on_day_one }
							Update_GDPC = yes
							news_event = { id = GDPC_Update.1 } #informs that you didn't do it :P
						}
						set_global_flag = do_not_do_on_day_one
					}
				}
				
				CHI = {
					if = { limit = { is_ai = yes }
						random_list = {
							#Undermine Taiwan
							7 = {
								TAI = {
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -180 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 0.2 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = { 
											limit = {
												OR = {
													check_variable = { influence_array^0 = ROOT }
													check_variable = { influence_array^1 = ROOT }
												}
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.2 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.3 }
												NOT = { check_variable = { party_popularity@communism > 0.45 } }
											}
											manipulate_politics_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							6 = { 
								PAK = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							6 = { 
								IND = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							6 = { 
								BRA = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							2 = {
								LAO = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
									}
								}
							}
							3 = {
								VEN = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 1.2 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							2 = {
								CBD = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
									}
								}
							}
							2 = {
								PHI = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							1 = {
								GRE = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							3 = {
								ETH = { 
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 0.8 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							4 = {
								DRC = {
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 1.2 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							4 = {
								AGL = {
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 1.2 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							1 = {
								GAB = {
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 1.2 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							2 = {
								SIA = {
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 1.2 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							4 = {
								MAY = {
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = { 
											limit = {
												check_variable = { size_modifier < 1.2 }
												NOT = { is_puppet_of = ROOT }
											}
											ROOT = {
												PREV = {
													country_event = { id = influence.0 }
												}
											}
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							4 = {
								SAF = {
									if = { limit = { NOT = { OR = { has_opinion = { target = ROOT value < -40 } is_in_faction_with = USA is_puppet = yes } } }
										spread_influence = yes
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.5 }
												NOT = { is_puppet_of = ROOT }
												NOT = {
													meta_trigger = {
														text = {
															has_idea = [CHECKTAG]_tribute_idea
														}
														CHECKTAG = "[?var:influence_array^0.GetTag]"
													}
												}
											}
											economic_exploitation_action = yes
										}
										if = {
											limit = {
												check_variable = { influence_array^0 = ROOT }
												check_variable = { influence_array_calc^0 > 0.8 }
												is_same_government = yes
												NOT = { is_puppet_of = ROOT }
												NOT = { has_war = yes }
											}
											make_puppet_action = yes
										}
									}
								}
							}
							50 = {
								modifier = {
									factor = 1.5
									has_political_power < 80
								}
								#don't waste if no gain
								modifier = {
									factor = 10
									political_power_daily < 2
								}
								modifier = {
									factor = 0.5
									political_power_daily > 4
								}
								modifier = {
									factor = 0.5
									political_power_daily > 6
								}
								modifier = {
									factor = 0.5
									political_power_daily > 8
								}
								modifier = {
									factor = 0.5
									political_power_daily > 8
								}
								#ignore influence at war
								modifier = {
									factor = 100
									has_war = yes
								}
							}
						}
					}
				}
			}
		}
	}
}