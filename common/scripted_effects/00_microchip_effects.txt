microchip_startup = {
	set_variable = { country_microchip_production_var = 0 }
	set_variable = { country_microchip_producing_var = 0 }
	add_dynamic_modifier = { modifier = microchip_production_modifier }
}

microchip_update = {
	if = {
		limit = {
			NOT = {
				has_dynamic_modifier = { modifier = microchip_production_modifier }
			}
		}
		add_dynamic_modifier = { modifier = microchip_production_modifier }
	}

	#Gather total resources available / to be produced
	set_temp_variable = { country_tech_remaining = resource@tungsten }
	set_temp_variable = { country_rare_remaining = resource@chromium }
	set_temp_variable = { country_microchip_produced = 0 }
	every_controlled_state = {
		add_to_temp_variable = { PREV.country_microchip_produced = non_damaged_building_level@microchip_plant }
	}
	#This is the BASE value for microchip production, or production per building.
	#ADJUSTING THIS WILL MASSIVELY CHANGE THE OUTPUT COSTS
	multiply_temp_variable = { country_microchip_produced = 8 }

	set_variable = { country_microchip_producing_var = country_microchip_produced }

	#set_temp_variable = { country_microchip_produced = resource_produced@microchips }

	set_temp_variable = { country_microchip_reducer = 0 }

	#Gather overall production demand
	#Math is here. Unless you know the math, PLEASE do not mess with these variables
	set_temp_variable = { country_tech_demand = 2 }
	multiply_temp_variable = { country_tech_demand = country_microchip_produced }
	divide_temp_variable = { country_tech_demand = 2 }
	round_temp_variable = country_tech_demand

	set_temp_variable = { country_rare_demand = 1 }
	multiply_temp_variable = { country_rare_demand = country_microchip_produced }
	divide_temp_variable = { country_rare_demand = 2 }
	round_temp_variable = country_rare_demand

	#First, check if we even need to do all this. If there is a surplus of both tech and precious metals, there is no need to adjust production

	if = {
		limit = {
			OR = {
				check_variable = { country_tech_remaining < 0 }
				check_variable = { country_rare_remaining < 0 }
			}
		}
		#Invert the numbers here for a fast check. Surplus now can't be higher than demand, since it's negative
		#Deficit now is positive, and can be used easily in the cost math since it's positive
		multiply_temp_variable = { country_tech_remaining = -1 }
		multiply_temp_variable = { country_rare_remaining = -1 }

		#If either input is critically low (greater than the input required)
		#Stop production due to the input lack
		if = {
			limit = {
				OR = {
					check_variable = { country_tech_remaining > country_tech_demand }
					check_variable = { country_rare_remaining > country_rare_demand }
				}
			}
			#Kill production here by setting the cost to the amount produced
			set_variable = { country_microchip_production_var = country_microchip_produced }
		}else = {
			#reduce production here by the chip needs
			#If it's negative here, there is no need to add to cost because it has a surplus or meets demand
			#If it's positive, then we have a deficit, and we just do the math to adjust production
			if = {
				limit = {
					check_variable = { country_tech_remaining > 0 }
				}
				divide_temp_variable = { country_tech_remaining = 2 }
				round_temp_variable = country_tech_remaining
				add_to_temp_variable = { country_microchip_reducer = country_tech_remaining }
			}
			if = {
				limit = {
					check_variable = { country_rare_remaining > 0 }
				}
				add_to_temp_variable = { country_microchip_reducer = country_rare_remaining }
			}

			set_variable = { country_microchip_production_var = country_microchip_reducer }
		}
	}else = {
		#There should be no reduction here, because we have a surplus of both inputs
		set_variable = { country_microchip_production_var = 0 }
	}
}